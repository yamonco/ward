name: Release Automation

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build package
      run: python -m build

    - name: Extract changelog
      id: changelog
      run: |
        # Extract changelog between current tag and previous tag
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -n "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$CURRENT_TAG)
        else
          CHANGELOG=$(git log --pretty=format:"- %s (%h)")
        fi

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        body: |
          ## Changes in this release

          ${{ steps.changelog.outputs.changelog }}

          ---

          ### Installation

          #### Using UV
          ```bash
          uv tool install --from git+https://github.com/yamonco/ward.git@${{ github.ref_name }} ward
          ```

          #### Using Docker
          ```bash
          docker pull yamonco/ward:${{ github.ref_name }}
          ```

          #### Using pip
          ```bash
          pip install ward-security==${{ github.ref_name }}
          ```

          ### Verification

          ```bash
          # Verify the installation
          ward --version
          ward-cli status
          ```
        files: |
          dist/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-push-release:
    name: Build and Push Release Artifacts
    runs-on: ubuntu-latest
    needs: create-release
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: yamonco/ward
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: Build and push bash release
      run: |
        # Create bash release archive
        mkdir -p release-bash
        cp -r .ward release-bash/
        cp README.md LICENSE release-bash/

        # Create setup script
        cat > release-bash/setup-ward.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "Installing Ward Security System..."

        # Create installation directory
        INSTALL_DIR="$HOME/.ward"
        mkdir -p "$INSTALL_DIR"

        # Copy files
        cp -r .ward/* "$INSTALL_DIR/"

        # Make scripts executable
        chmod +x "$INSTALL_DIR"/*.sh
        chmod +x "$INSTALL_DIR"/core/*.sh

        # Add to PATH
        if ! grep -q '$HOME/.ward' ~/.bashrc 2>/dev/null; then
            echo 'export PATH="$HOME/.ward:$PATH"' >> ~/.bashrc
        fi

        if ! grep -q '$HOME/.ward' ~/.zshrc 2>/dev/null; then
            echo 'export PATH="$HOME/.ward:$PATH"' >> ~/.zshrc
        fi

        echo "Installation completed! Please restart your shell or run:"
        echo "export PATH=\"\$HOME/.ward:\$PATH\""
        echo ""
        echo "Then run: ward-cli --help"
        EOF

        chmod +x release-bash/setup-ward.sh

        # Create archive
        tar -czf ward-bash-${{ github.ref_name }}.tar.gz -C release-bash .

    - name: Upload bash release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ward-bash-${{ github.ref_name }}.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}